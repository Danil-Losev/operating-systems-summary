#Operating_Systems #OS_File_System 
## Файл как универсальная метафора
### Виртуальное определение файла
**Виртуальный файл** - именованная совокупность данных. Это определение описывает виртуальный файл - каким он представляется пользователю.

#### Ключевые особенности виртуального представления:
- **Абстракция от физического размещения**: определение не конкретизирует, где именно и на каких носителях находятся данные
- **Нет привязки к структуре**: не определяет, из каких элементов совокупность состоит и каковы отношения между элементами
- **Универсальность**: отсутствие детализации делает файл удобной универсальной метафорой любых внешних по отношению к процессу данных

### Историческое развитие концепции
**Unix - первопроходец файловой метафоры**:
- В ОС Unix впервые было введено представление всех внешних устройств как виртуальных файлов
- Это представление прочно укоренилось в современных операционных системах
- Существует тенденция более широкого использования файловой метафоры

#### Современное применение:
В современных системах имена всех внешних по отношению к процессу именованных данных формируются по соглашениям именования файлов:
- Семафоры
- Каналы-транспортеры (pipes)
- Очереди сообщений
- Другие объекты IPC (межпроцессного взаимодействия)

### Преимущества универсальной метафоры:
1. **Единообразный интерфейс** - одни и те же операции для работы с разными типами данных
2. **Простота использования** - пользователь не думает о деталях реализации
3. **Расширяемость** - легко добавлять новые типы объектов
4. **Переносимость** - программы могут работать с разными устройствами одинаково

---
## Физическое представление файла
### Определение физического файла
**Физический файл** - данные, хранящиеся на внешней памяти.

### Назначение устройств внешней памяти
Устройства внешней памяти предназначены для **длительного хранения данных**:
- Файл, созданный на внешней памяти, может существовать сколь угодно долго
- Уничтожается только явно заданной операцией удаления
- **Персистентность** (постоянство): файл продолжает существовать после завершения создавшего его процесса

### Характеристики физического файла:
#### 1. Долговечность
- Данные сохраняются между сеансами работы системы
- Не зависят от работы процессов
- Требуют явного удаления

#### 2. Многократное использование
- Данные файла могут быть многократно прочитаны
- Возможна модификация содержимого
- Полная замена данных
- Доступ может осуществляться разными процессами

#### 3. Физическая структура
**Физический файл** представляет собой набор записей на устройстве внешней памяти, сгруппированных таким образом, чтобы обеспечить:
- Управление доступом к данным
- Эффективное чтение
- Возможность модификации

### Отличия от виртуального представления:
| Виртуальный файл         | Физический файл                   |
| ------------------------ | --------------------------------- |
| Абстрактная концепция    | Реальные данные на носителе       |
| Не привязан к устройству | Размещен на конкретном устройстве |
| Простое имя              | Адреса блоков на диске            |
| Единое целое             | Набор записей/блоков              |

---
## Файловая система и её задачи
### Определение файловой системы
**Файловая система (ФС)** - та часть операционной системы, которая обеспечивает перевод виртуального представления файла в физическое.

### Принцип работы
Перевод из виртуального представления в физическое выполняется **поэтапно**, что позволяет представить ФС в виде иерархической модели.

#### Основные задачи ФС:
1. **Трансляция имен** - преобразование символьных имен файлов в физические адреса
2. **Управление пространством** - выделение и освобождение дискового пространства
3. **Организация доступа** - обеспечение операций чтения/записи
4. **Защита данных** - контроль прав доступа
5. **Обеспечение надежности** - защита от потери данных

### Многоуровневая архитектура
Файловая система работает как серия уровней абстракции, где каждый уровень:
- Выполняет специфические функции
- Предоставляет интерфейс для вышестоящего уровня
- Использует сервисы нижестоящего уровня
- Скрывает детали реализации от верхних уровней

---
## Иерархическая модель файловой системы
### Общая структура уровней
Файловая система организована в виде иерархии из нескольких уровней, каждый из которых выполняет специфические функции:

```
┌─────────────────────────────────┐
│       Приложения                │
├─────────────────────────────────┤
│  Логическая файловая система    │
├─────────────────────────────────┤
│  Модуль файловой организации    │
├─────────────────────────────────┤
│  Базовая (базисная) ФС          │
├─────────────────────────────────┤
│  Управление вводом-выводом      │
├─────────────────────────────────┤
│        Устройства               │
└─────────────────────────────────┘
```

![[OS 75.png]]

![[OS 76.png]]
### Уровень 1: Устройства (Hardware Level)
**Физический уровень оборудования** - магнитные диски с подвижными головками
#### Структура магнитного диска:
![[OS 7.png]]

**Компоненты:**
- **Пластины (поверхности)** - магнитные диски, собранные в пакет
- **Магнитные головки** - расположены на одном рычаге, движутся синхронно
- **Цилиндр** - логическое понятие, соответствует одному положению пакета головок
- **Дорожка (трек)** - концентрическая окружность на одной поверхности
- **Блок (сектор)** - минимальная единица хранения данных на дорожке

#### Параметры адресации блока:
Для обмена с магнитным диском на уровне аппаратуры необходимо указать:
1. **Номер цилиндра** - положение головок
2. **Номер поверхности** - выбор конкретной головки
3. **Номер блока** - позиция на дорожке
4. **Количество байтов** - объем данных для чтения/записи от начала блока

#### Особенности организации:
- Диски разбиты на блоки **фиксированного размера**
- Возможен **прямой доступ** к любому блоку (random access)
- Каждая дорожка размечена на одинаковое количество блоков
- В каждый блок можно записать одинаковое максимальное число байтов

### Уровень 2: Управление вводом-выводом (I/O Control)
**Подсистема ввода-вывода** - непосредственно взаимодействует с физическими устройствами.

#### Основные компоненты:
**1. Драйверы устройств (Device Drivers)**:
- Получают команды высокого уровня (например, "считать блок 123")
- Преобразуют их в инструкции низкого уровня для конкретного контроллера
- Работают с контроллером через запись битов в память контроллера
- Специфичны для каждого типа устройств

**2. Программы обработки прерываний (ISR - Interrupt Service Routines)**:
- Обрабатывают прерывания от контроллеров устройств
- Информируют систему о завершении операций ввода-вывода
- Обрабатывают ошибки устройств

#### Функции подсистемы:
- **Формирование управляющих воздействий** на устройства внешней памяти
- **Выполнение команд** ввода-вывода
- **Обработка прерываний** от устройств
- **Передача данных** между памятью и диском

#### Интерфейс для файловой системы:
Система ввода-вывода предоставляет файловой системе дисковое пространство в виде:
- **Непрерывной последовательности блоков**
- Блоки имеют **фиксированный размер**
- Блоки пронумерованы от 0 (или 1) до N
- Абстракция от физической геометрии диска

### Уровень 3: Базовая (базисная) файловая система
**Модуль физической организации файлов** - выполняет перевод виртуальных файловых адресов в реальные адреса на носителях.

#### Основные функции:
**1. Трансляция адресов**:
- Работает с **логическими блоками** файла (нумерация от 0 до n)
- Знает о типе размещения файла на диске
- Транслирует адрес логического блока в адрес физического блока
- Передает физический адрес подсистеме ввода-вывода

**2. Управление размещением**:
- Отслеживает размещение файлов на внешней памяти
- Управляет распределением пространства внешней памяти
- Содержит **менеджер свободного пространства**

**3. Управление файловыми дескрипторами**:
**Дескриптор файла** - системная структура данных, содержащая:
- Информацию о местонахождении файла
- Характеристики файла (размер, владелец, права доступа)
- Текущее состояние файла

#### Операции с файлами:
**Открытие файла**:
- Находит дескриптор файла по идентификатору
- Создает **расширенный дескриптор** для отслеживания текущего состояния
- Добавляет файл в таблицу открытых файлов
- Возможно, контролирует соблюдение прав доступа

**Закрытие файла**:
- Удаляет расширенный дескриптор
- Обновляет основной дескриптор
- Освобождает системные ресурсы

#### Взаимодействие с логическими блоками:
- Размер логических блоков совпадает или кратен размеру физического блока диска
- Может быть равен размеру страницы виртуальной памяти
- Обеспечивает эффективное взаимодействие с системой управления памятью

### Уровень 4: Модуль файловой организации
**Логическая организация файлов** - определяет способ размещения данных файла на диске.
#### Типы организации файлов:
1. **Непрерывное размещение** (contiguous allocation)
2. **Связанное размещение** (linked allocation)
3. **Индексное размещение** (indexed allocation)

#### Функции модуля:
- Выбор стратегии размещения файла
- Поддержка структуры размещения
- Оптимизация доступа к данным файла

### Уровень 5: Логическая файловая система
**Логическая ФС** - управляет метаданными и структурой директорий.
#### Метаданные файловой системы:
**Метаданные** - все, что известно о файловой системе, за исключением самих данных:
- Структура директорий
- Информация о файлах (атрибуты)
- Права доступа
- Информация о размещении

#### Основные компоненты:
**1. Управление структурой директорий**:
- Поддержка иерархии каталогов
- Операции поиска файлов по имени
- Создание и удаление директорий
- Обход дерева каталогов

**2. File Control Block (FCB)**:
**Блок управления файлом** содержит:
- **Права доступа** (read, write, execute)
- **Временные метки**:
  - Время создания
  - Время последнего доступа
  - Время последнего изменения
- **Владелец и группа**
- **ACL** (Access Control List) - список дополнительных прав доступа
- **Размер файла**
- **Информация о размещении**:
  - Блоки данных
  - Указатели на блоки данных

**Особенности FCB в разных системах:**
- В **UFS** (Unix File System): называется **inode**
- В **NTFS** (New Technology File System): информация содержится в **Master File Table**

**3. Предоставление информации нижним уровням**:
- Передает модулю организации файлов необходимую информацию
- Обеспечивает трансляцию символьных имен

#### Процесс авторизации доступа:
1. Проверка прав текущего пользователя
2. Сверка с правами доступа к файлу
3. Проверка ACL (если есть)
4. Разрешение или запрет операции

### Уровень 6: Приложения
**Пользовательские программы** - используют файловую систему через системные вызовы.
#### Основные операции:
- Открытие/закрытие файлов
- Чтение/запись данных
- Создание/удаление файлов
- Управление атрибутами

---
## Структура файловой системы
### Процесс обработки запросов
#### Последовательность обработки запроса на открытие файла

**Стандартный запрос** - `open()` или `create()` от прикладной программы:

**Шаг 1: Логическая подсистема**
- Получает запрос от прикладной программы
- Использует структуру директорий для поиска файла
- **Проверяет права доступа**:
  - Сопоставляет идентификатор процесса с владельцем файла
  - Проверяет права пользователя и группы
  - Проверяет ACL при наличии
- Вызывает базовую подсистему для получения доступа к блокам файла

**Шаг 2: Базовая подсистема**
- Находит или создает дескриптор файла
- Создает расширенный дескриптор для отслеживания состояния
- Добавляет файл в таблицу открытых файлов

**Шаг 3: Возврат результата**
- Файл считается **открытым**
- Прикладная программа получает **дескриптор файла** (file descriptor)
- В системах Microsoft дескриптор называется **handle**

#### Дескриптор файла (File Descriptor/Handle):
- Является **ссылкой** на файл в таблице открытых файлов
- Используется во всех последующих операциях с файлом
- Обеспечивает быстрый доступ к информации о файле

### Таблицы открытых файлов
Файловая система поддерживает два уровня таблиц открытых файлов:

![[OS 77.png]]

#### 1. Системная таблица открытых файлов (System-Wide Open File Table)
**Содержимое записи:**
- Копия FCB (File Control Block)
- Режим доступа к файлу
- Счетчик ссылок (количество процессов, использующих файл)
- Указатель на блоки данных через систему выделения блоков диска

**Характеристики:**
- Одна на всю систему
- Содержит информацию обо всех открытых в системе файлах
- Управляется ядром операционной системы

#### 2. Таблица открытых файлов процесса (Per-Process Open File Table)
**Содержимое записи:**
- Дескриптор файла (file descriptor number)
- Указатель на запись в системной таблице открытых файлов
- Текущая позиция в файле (file pointer)
- Флаги доступа процесса

**Характеристики:**
- Своя у каждого процесса
- Содержит только файлы, открытые данным процессом
- При завершении процесса автоматически очищается

#### Совместный доступ к файлам
**Ситуация**: Файл уже используется другим процессом (содержится в таблице открытых файлов).

**Процесс открытия:**
1. Логическая подсистема проверяет права доступа
2. Проверяется возможность совместного использования (sharing mode)
3. При успешной проверке новому процессу возвращается дескриптор
4. Оба дескриптора ссылаются на **одну запись** в системной таблице
5. Счетчик ссылок в системной таблице увеличивается

**Преимущества совместного доступа:**
- Экономия памяти (одна копия FCB на все процессы)
- Синхронизация изменений
- Контроль конфликтов доступа

### Использование модульности
#### Переиспользование компонентов:
**Система ввода-вывода и базовая файловая система**:
- Могут быть использованы **несколькими файловыми системами**
- Обеспечивают общий интерфейс к оборудованию
- Независимы от типа файловой системы

**Каждая ФС может иметь:**
- Свою логическую файловую систему
- Свой модуль организации файлов
- Собственный формат метаданных

#### Примеры сосуществования ФС:
- FAT32 и NTFS на Windows
- ext4, XFS, Btrfs на Linux
- APFS и HFS+ на macOS

---
## Реализация файловой системы
### Структуры данных для реализации
Для реализации файловой системы используются несколько структур на диске и в памяти. Они различаются от системы к системе, но существуют основные принципы.

#### Информация на диске:
- Как загружать операционную систему
- Количество блоков
- Количество и расположение свободных блоков
- Структура директорий
- Содержимое файлов

#### Информация в памяти:
- Таблица смонтированных файловых систем
- Кэш структуры директорий
- Таблицы открытых файлов
- Буферы для операций ввода-вывода

### Структуры файловой системы на диске
#### 1. Загрузочная запись (Boot Sector)
**Сектор 0 диска - Master Boot Record (MBR)**:
- Используется для загрузки операционной системы
- Содержит таблицу разделов в конце
- Один раздел помечается как активный
- MBR считывает первый блок активного раздела и исполняет его

**Загрузочный блок раздела (Partition Boot Sector)**:
- Первый блок файловой системы на разделе
- Содержит информацию для загрузки ОС с этого раздела
- Если раздел не содержит ОС, блок будет пустым или содержать заглушку

**Именование в разных системах:**
- **UFS**: boot block
- **NTFS**: partition boot sector

#### 2. Блок управления томом/разделом (Volume Control Block)
**Суперблок** - содержит ключевые параметры файловой системы.

**Содержимое суперблока:**
- **Магическое число** (magic number) - для идентификации типа ФС
- **Количество блоков** в файловой системе
- **Размер блока** - в байтах
- **Счетчик свободных блоков** - количество доступных блоков
- **Указатель на список свободных блоков**
- **Счетчик FCB** - количество файловых дескрипторов
- **Указатель на FCB** - расположение дескрипторов файлов

**Именование в разных системах:**
- **UFS**: superblock
- **NTFS**: Master File Table (частично)

**Момент загрузки:**
- Считывается при загрузке системы
- Или при первом обращении к файловой системе
- Кэшируется в памяти для быстрого доступа

#### 3. Структура директорий (Directory Structure)
**Назначение**: организация файлов в файловой системе.

На одну файловую систему создается одна структура директорий.

**Содержимое записи директории в UFS:**
- Имя файла (file name)
- Номер индексного узла (inode number)
- Тип записи (файл, директория, символическая ссылка)

**Содержимое в NTFS:**
- Информация содержится в Master File Table
- Организована как реляционная база данных
- Одна строка на каждый файл или директорию

#### 4. File Control Block (FCB) - Блок управления файлом
**Один FCB на каждый файл** в системе.

**Детальная информация о файле:**
- **Права доступа** (permissions):
  - Права владельца (owner)
  - Права группы (group)
  - Права остальных пользователей (others)
  - В Unix: rwx (read, write, execute)
- **Владелец файла** (owner user ID)
- **Группа** (group ID)
- **Размер файла** в байтах
- **Размещение блоков данных**:
  - Прямые указатели на блоки
  - Косвенные указатели (для больших файлов)
  - Двойные/тройные косвенные указатели
- **Временные метки**:
  - Время создания
  - Время последнего доступа
  - Время последней модификации

**Именование в разных системах:**
- **UFS**: inode (index node)
- **NTFS**: запись в Master File Table

**Структура inode в UFS:**
```
inode содержит:
- Метаданные файла
- Прямые указатели на блоки (обычно 12-15)
- Одинарный косвенный указатель
- Двойной косвенный указатель
- Тройной косвенный указатель
```

**NTFS Master File Table:**
- Реляционная структура
- Строка на каждый файл
- Содержит все метаданные и даже небольшие файлы целиком


![[OS 78.png]]

### Структуры файловой системы в памяти
#### 1. Таблица смонтированных файловых систем (Mount Table)
**Содержимое:**
- Список всех смонтированных (подключенных) файловых систем
- Точка монтирования (mount point) для каждой ФС
- Тип файловой системы (ext4, NTFS, FAT32 и т.д.)
- Флаги монтирования (read-only, read-write и т.д.)
- Указатель на суперблок в памяти

**Назначение:**
- Быстрый доступ к информации о доступных ФС
- Определение, к какой ФС относится путь к файлу

#### 2. Кэш структуры директорий (Directory Structure Cache)
**Содержит:**
- Информацию о директориях, к которым был недавний доступ
- Для директорий, к которым примонтирована ФС - указатель на том
- Результаты недавних поисков файлов

**Назначение:**
- Ускорение повторного доступа к файлам
- Уменьшение количества обращений к диску
- Кэширование результатов трансляции имен

**Особенности:**
- Наиболее актуальная информация (новее, чем на диске)
- При сбое системы может быть потеряна
- Требует механизмов синхронизации с диском

#### 3. Системная таблица открытых файлов (System-Wide Open File Table)
**Содержимое каждой записи:**
- **Копия FCB** из диска
- **Режим доступа** (read, write, append и т.д.)
- **Счетчик ссылок** - количество процессов, работающих с файлом
- **Указатель на блоки данных** через систему выделения блоков диска
- **Блокировки** (locks) для синхронизации доступа

**Характеристики:**
- Одна таблица на всю систему
- Управляется ядром ОС
- Обеспечивает совместный доступ к файлам

#### 4. Таблица открытых файлов процесса (Per-Process Open File Table)
**Содержимое каждой записи:**
- **Дескриптор файла** (file descriptor) - целое число
- **Указатель** на запись в системной таблице открытых файлов
- **Текущая позиция** в файле (offset)
- **Флаги** процесса (close-on-exec и др.)

**Характеристики:**
- Своя таблица у каждого процесса
- Автоматически очищается при завершении процесса
- Дескрипторы 0, 1, 2 обычно зарезервированы (stdin, stdout, stderr)

![[OS 66.png]]
### Схема взаимодействия структур
```
Процесс 1                   Процесс 2
  |                            |
  | fd=3                       | fd=5
  |                            |
  v                            v
[Таблица открытых             [Таблица открытых
 файлов процесса 1]            файлов процесса 2]
  |                            |
  +----------+  +--------------+
             |  |
             v  v
    [Системная таблица открытых файлов]
             |
             | Указатель на FCB
             v
         [FCB на диске]
             |
             | Указатели на блоки
             v
       [Блоки данных файла]
```

---
## Обеспечение надежности
### Метаданные и их важность
**Метаданные** - данные о файловой системе, системе директорий и формате диска.

#### Виды метаданных:
- Суперблок файловой системы
- Информация о директориях
- Дескрипторы файлов (FCB, inode)
- Карты свободного пространства
- Журналы транзакций

### Проблема повреждения файловой системы
Файловые системы, как **локальные**, так и **удаленные**, легко могут быть повреждены, что приводит к нарушению **согласованности (консистентности)** ФС.

#### Причины повреждений:
1. **Внезапное отключение питания**
2. **Сбой оборудования** (диск, контроллер)
3. **Ошибки программного обеспечения** (баги в драйверах, ОС)
4. **Некорректное завершение работы системы**
5. **Физическое повреждение носителя**

### Консистентность файловой системы
#### Проверка консистентности (Consistency Check)
**Суть проверки**: сравнение информации о файлах из структуры директорий с информацией на диске.

**Проблема рассинхронизации:**
- Кэш структуры директорий обычно содержит наиболее новую информацию
- При сбое новая информация может не успеть записаться на диск
- Возникает **несоответствие** между записью в директории и реальным файлом на диске

#### Типичные несоответствия:
**1. Потерянные блоки (Lost Blocks)**:
- Блоки не помечены как свободные
- Не принадлежат ни одному файлу
- Уменьшают доступное пространство

**2. Дублирование блоков (Duplicate Blocks)**:
- Один блок числится в нескольких файлах
- Может привести к повреждению данных

**3. Несоответствие размеров**:
- Размер в дескрипторе не соответствует реальному количеству блоков

**4. Недоступные файлы (Orphaned Files)**:
- Файл существует, но нет ссылки из директорий
- Помещаются в lost+found (в Unix)

#### Утилиты проверки:
- **fsck** (file system check) в Unix/Linux
- **chkdsk** (check disk) в Windows
- **e2fsck** для ext2/ext3/ext4
- Запускаются обычно при загрузке после некорректного завершения

### Резервное копирование и восстановление
#### 1. Полный бэкап (Full Backup)
**Характеристики:**
- Копируются **все файлы** системы
- Служит базой для инкрементного копирования
- Требует больше времени и места
- Восстановление происходит быстро

**Когда использовать:**
- Периодически (еженедельно, ежемесячно)
- Перед критическими изменениями
- Для долгосрочного архивирования

#### 2. Инкрементный бэкап (Incremental Backup)
**Характеристики:**
- Копируются только **измененные файлы** с момента последнего бэкапа
- Требует меньше времени и места
- Восстановление сложнее (нужны все инкременты)

**Принцип работы:**
1. Проверяется время последней модификации файла
2. Если файл изменен - копируется
3. Если не изменен - пропускается

**Типы инкрементного копирования:**
- **Дифференциальный** - с момента последнего полного бэкапа
- **Собственно инкрементный** - с момента любого последнего бэкапа

#### 3. RAID (Redundant Array of Independent Disks)
**Назначение**: обеспечение отказоустойчивости и/или производительности.

**Основные уровни RAID:**
**RAID 0** (Striping):
- Данные распределяются по нескольким дискам
- Высокая производительность
- **Нет избыточности** - не защищает от сбоев

**RAID 1** (Mirroring):
- Полное зеркалирование данных
- Высокая надежность
- Требует двойного объема дисков

**RAID 5** (Striping with Parity):
- Данные и четность распределены по дискам
- Выдерживает отказ одного диска
- Хороший баланс производительности и надежности

**RAID 6**:
- Двойная четность
- Выдерживает отказ двух дисков

**RAID 10** (1+0):
- Комбинация зеркалирования и чередования
- Высокая производительность и надежность

**Важно**: RAID **не заменяет** резервное копирование!

#### 4. Расписание резервного копирования
**Стратегия "Дед-отец-сын"**:
- **Ежедневные** бэкапы (сын) - хранятся неделю
- **Еженедельные** бэкапы (отец) - хранятся месяц
- **Ежемесячные** бэкапы (дед) - хранятся год или дольше

**Правило 3-2-1**:
- **3** копии данных
- **2** разных типа носителей
- **1** копия хранится удаленно (offsite)

### Журналирование (Journaling)
#### Концепция журналирования
Файловая система рассматривается как **база данных**, используются техники ведения журнала транзакций.

**Log-based Transaction** - ведение журнала изменений:
- Аналогично журналу транзакций в СУБД
- Все изменения сначала записываются в журнал
- Затем применяются к файловой системе

#### Принцип работы:
**Последовательность операций:**
1. **Начало транзакции** записывается в журнал
2. **Планируемые изменения** записываются в журнал
3. **Commit** - фиксация транзакции в журнале
4. **Применение изменений** к файловой системе
5. **Удаление записи** из журнала после успешного применения

**При сбое:**
1. Система проверяет журнал
2. Незавершенные транзакции откатываются
3. Зафиксированные, но не примененные транзакции - применяются
4. Восстановление происходит быстро

#### Типы журналирования:
**1. Журналирование метаданных (Metadata Journaling)**:
- Журналируются только изменения метаданных
- Быстрее, требует меньше места
- Пример: ext3 в режиме ordered, ext4

**2. Полное журналирование (Full Journaling)**:
- Журналируются и метаданные, и данные
- Максимальная надежность
- Медленнее, требует больше места
- Пример: ext3 в режиме journal

**3. Режим Write-Back**:
- Минимальное журналирование
- Максимальная производительность
- Меньшая надежность

#### Преимущества журналирования:
- **Быстрое восстановление** после сбоя
- **Гарантия целостности** метаданных
- Возможность **отката** на любой момент времени или контрольную точку
- **Атомарность операций** - либо выполняются полностью, либо не выполняются

#### Недостатки:
- **Затраты пространства** диска под журнал
- **Затраты времени** на ведение журнала
- Усложнение реализации файловой системы
---
## Защита и безопасность
### Логическая файловая система - механизмы защиты
Логическая файловая система отвечает за реализацию механизмов защиты и безопасности данных.
### Пользователи и группы
#### Пользователи (Users)
**Идентификация пользователя:**
- **UID** (User ID) - уникальный числовой идентификатор
- **Имя пользователя** (username) - символьное имя
- **Суперпользователь** (root, Administrator) - UID 0, неограниченные права

**Атрибуты пользователя:**
- Домашняя директория
- Оболочка по умолчанию (shell)
- Группы, к которым принадлежит

#### Группы (Groups)
**Назначение:** объединение пользователей для упрощения управления правами доступа.

**Идентификация группы:**
- **GID** (Group ID) - уникальный числовой идентификатор группы
- **Имя группы** (group name)

**Типы групп:**
- **Первичная группа** (primary group) - основная группа пользователя
- **Дополнительные группы** (supplementary groups) - пользователь может быть членом нескольких

### Права доступа
#### Модель прав доступа в Unix/Linux
**Три категории субъектов:**
1. **Владелец** (Owner, User) - создатель файла
2. **Группа** (Group) - члены группы-владельца
3. **Остальные** (Others, World) - все прочие пользователи

**Три типа прав:**
1. **Read (r)** - чтение
   - Для файлов: просмотр содержимого
   - Для директорий: просмотр списка файлов
2. **Write (w)** - запись
   - Для файлов: изменение содержимого
   - Для директорий: создание/удаление файлов
3. **Execute (x)** - исполнение
   - Для файлов: запуск как программы
   - Для директорий: вход в директорию (cd)

**Представление прав:**
```
-rwxr-xr--
││││││││││
│││││││└└└─ Others: r-- (read only)
││││└└└──── Group: r-x (read, execute)
│└└└─────── Owner: rwx (read, write, execute)
└────────── File type (- = file, d = directory, l = link)
```

**Числовое представление (восьмеричное):**
- r = 4, w = 2, x = 1
- Пример: 755 = rwxr-xr-x
  - 7 (4+2+1) = rwx для владельца
  - 5 (4+1) = r-x для группы
  - 5 (4+1) = r-x для остальных

#### Специальные права:
**SUID (Set User ID)** - бит 4000:
- При запуске программа выполняется с правами владельца файла
- Используется для программ, требующих повышенных привилегий
- Пример: команда `passwd`

**SGID (Set Group ID)** - бит 2000:
- Для файлов: программа выполняется с правами группы
- Для директорий: новые файлы наследуют группу директории

**Sticky bit** - бит 1000:
- Для директорий: удалять файлы могут только владельцы
- Пример: `/tmp`

### Списки доступа (Access Control Lists - ACL)
**Назначение**: расширенная модель прав, позволяющая задавать права для конкретных пользователей и групп.
#### Преимущества ACL:
- Более **гибкое управление** правами
- Можно дать права **конкретному пользователю**, не делая его членом группы
- Можно задать права для **нескольких групп**
- **Дополняет**, а не заменяет стандартные права

#### Пример использования ACL:
```bash
# Просмотр ACL
getfacl файл

# Установка ACL
setfacl -m u:user1:rw файл     # Дать user1 права на чтение и запись
setfacl -m g:group1:rx файл    # Дать group1 права на чтение и исполнение
```

**Структура записи ACL:**
- **Тип субъекта**: пользователь (u), группа (g), маска (m), другие (o)
- **Имя субъекта**: конкретное имя или пусто для владельца/группы
- **Права**: rwx в любой комбинации

### Шифрование
#### Уровни шифрования:
**1. Шифрование отдельных файлов**:
- Шифруются конкретные файлы средствами приложений
- Пример: зашифрованные архивы, документы
- **Плюсы**: точечная защита, портативность
- **Минусы**: неудобство, легко забыть зашифровать

**2. Шифрование файловой системы**:
- Прозрачное шифрование на уровне ФС
- Примеры: **eCryptfs** (Linux), **EFS** (Windows)
- **Плюсы**: автоматическое шифрование, прозрачность для пользователя
- **Минусы**: метаданные могут быть не зашифрованы

**3. Шифрование разделов**:
- Шифруется весь раздел диска
- Примеры: **LUKS** (Linux), **BitLocker** (Windows), **FileVault** (macOS)
- **Плюсы**: защита всех данных, включая метаданные
- **Минусы**: требует ввода пароля при загрузке

**4. Шифрование дисков (Full Disk Encryption)**:
- Шифрование всего физического диска
- Примеры: аппаратное шифрование в SSD, **VeraCrypt**
- **Плюсы**: максимальная защита, защита MBR
- **Минусы**: производительность, сложность восстановления

#### Методы шифрования:
**Симметричное шифрование**:
- Используется один ключ для шифрования и расшифровки
- Алгоритмы: **AES** (Advanced Encryption Standard), **ChaCha20**
- Быстрая работа, подходит для больших объемов

**Асимметричное шифрование**:
- Пара ключей: публичный (для шифрования) и приватный (для расшифровки)
- Алгоритмы: **RSA**, **ECC** (Elliptic Curve Cryptography)
- Используется для обмена ключами, электронной подписи

#### Безопасность паролей:
**Хранение ключей:**
- Пароли не хранятся в открытом виде
- Используются криптографические **хэш-функции** (SHA-256, bcrypt)
- **Соль** (salt) - случайные данные, добавляемые к паролю перед хешированием
- Защита от rainbow-table атак

### Комплексная защита
#### Принципы безопасности:
**1. Принцип наименьших привилегий**:
- Пользователи и процессы имеют только необходимые права
- Минимизация ущерба при компрометации

**2. Разделение обязанностей**:
- Критические операции требуют действий нескольких пользователей
- Защита от злоупотреблений

**3. Глубокая защита (Defense in Depth)**:
- Несколько уровней защиты
- Компенсация слабостей одного уровня другим

**4. Аудит и логирование**:
- Запись всех попыток доступа к защищенным ресурсам
- Анализ журналов для выявления аномалий
- Юридическая значимость логов

#### Современные подходы:
**Mandatory Access Control (MAC)**:
- Обязательный контроль доступа
- Реализации: **SELinux**, **AppArmor**
- Политики безопасности определяются администратором
- Пользователь не может изменить права доступа

**Role-Based Access Control (RBAC)**:
- Управление доступом на основе ролей
- Пользователям назначаются роли
- Роли имеют определенные права
- Упрощает администрирование в больших системах