#Operating_Systems #OS_Input_Output
## Введение: Жёсткий диск как устройство хранения
### Что такое жёсткий диск?
**Жёсткий диск (Hard Disk Drive, HDD)** — это основное устройство долговременного хранения данных в компьютерных системах, использующее принцип магнитной записи на вращающихся пластинах (дисках).

### Ключевые особенности
- **Энергонезависимость** — данные сохраняются после выключения питания
- **Большой объём** — современные диски могут хранить терабайты информации
- **Блочный доступ** — данные читаются и записываются блоками (секторами)
- **Механическое устройство** — содержит движущиеся части (головки, пластины)

> **Важность для ОС:** Жёсткие диски являются критически важным компонентом для файловых систем и виртуальной памяти.

---
## Физическая структура жёсткого диска

![[OS 7.png]]

![[OS 94.png]]
### Основные компоненты
#### 1. Магнитные пластины (Platters)
**Описание:**
- Круглые диски, покрытые ферромагнитным материалом
- Вращаются с постоянной скоростью (5400, 7200, 10000, 15000 об/мин)
- Обычно несколько пластин в одном корпусе

**Стороны пластины:**
- Каждая пластина имеет **две стороны** (верхнюю и нижнюю)
- Каждая сторона может использоваться для записи данных

#### 2. Магнитные головки (Read/Write Heads)
**Описание:**
- По одной головке на каждую рабочую поверхность пластины
- Головки **не касаются** поверхности диска
- Зазор между головкой и поверхностью — доли микрометра
- Все головки **перемещаются синхронно** (закреплены на одном блоке)

**Функции:**
- **Чтение** — считывание магнитного поля с поверхности
- **Запись** — изменение магнитного поля на поверхности

#### 3. Актуатор (Actuator)
**Описание:**
- Механизм перемещения головок
- Обычно использует **voice coil** (катушка голосовой связи)
- Позволяет головкам перемещаться от центра к краю пластины

#### 4. Шпиндель (Spindle)
**Описание:**
- Ось, на которой закреплены пластины
- Вращается с постоянной скоростью
- Приводится в движение **электродвигателем**

### Геометрическая организация
#### Дорожки (Tracks)
**Дорожка** — концентрическая окружность на поверхности пластины.
**Характеристики:**
- Дорожки **нумеруются** от внешнего края к центру (обычно от 0)
- На современных дисках — тысячи дорожек
- Расстояние между дорожками — микроны

#### Цилиндры (Cylinders)
**Цилиндр** — совокупность дорожек с одинаковым номером на всех поверхностях всех пластин.

**Пояснение:**
- Если головки находятся на дорожке N на одной поверхности
- То на всех остальных поверхностях они находятся на дорожке N
- Все эти дорожки вместе образуют цилиндр N

**Преимущество концепции цилиндра:**
> Данные, расположенные в одном цилиндре, могут быть прочитаны **без перемещения головок** — только переключением между головками и ожиданием вращения.

#### Секторы (Sectors)
**Сектор** — минимальная адресуемая единица данных на диске.
**Характеристики:**
- Дорожка делится на секторы (обычно 512 байт или 4096 байт)
- Секторы **нумеруются** от начала дорожки
- Количество секторов на дорожке может быть **разным** (зависит от зоны)

**Стандартные размеры секторов:**
- **Классический:** 512 байт
- **Advanced Format:** 4096 байт (4 КБ)
---
## Характеристики производительности диска
### Время доступа к данным
**Общее время доступа** складывается из трёх компонентов:

#### 1. Время поиска (Seek Time)
**Определение:**
Время, необходимое для перемещения головки на нужный цилиндр.

**Характеристики:**
- **Зависит от расстояния** перемещения
- Обычно измеряется **среднее время поиска** (average seek time)
- Типичные значения: 3-15 мс

**Типы времени поиска:**
- **Track-to-track seek time** — переход на соседнюю дорожку (~0.2-1 мс)
- **Average seek time** — среднее время поиска (~3-10 мс)
- **Full stroke seek time** — переход от края до края (~15-20 мс)

> **Критично:** Время поиска **значительно превосходит** две другие составляющие времени доступа!

#### 2. Задержка вращения (Rotational Latency)
**Определение:**
Время, необходимое для поворота нужного сектора под головку чтения/записи.

**Характеристики:**
- Зависит от **скорости вращения** диска
- В среднем — половина оборота диска

**Расчёт средней задержки вращения:**

Для диска со скоростью 7200 об/мин:
- Время одного оборота = 60 с / 7200 = 8.33 мс
- Средняя задержка = 8.33 мс / 2 = **4.17 мс**

**Типичные значения:**

| Скорость вращения | Время оборота | Средняя задержка |
|-------------------|---------------|------------------|
| 5400 об/мин       | 11.11 мс      | 5.56 мс          |
| 7200 об/мин       | 8.33 мс       | 4.17 мс          |
| 10000 об/мин      | 6.00 мс       | 3.00 мс          |
| 15000 об/мин      | 4.00 мс       | 2.00 мс          |

#### 3. Время передачи данных (Transfer Time)
**Определение:**
Время, необходимое для передачи данных между диском и памятью.

**Характеристики:**
- Зависит от **скорости вращения** диска
- Зависит от **плотности записи** на дорожке
- Зависит от **объёма** передаваемых данных

**Расчёт времени передачи:**
```
Время передачи = Объём данных / Скорость передачи
```

**Типичная скорость передачи:** 100-200 МБ/с для внешних дорожек

### Оптимизация производительности
**Вывод из анализа компонентов времени доступа:**

> Поскольку **время поиска** значительно превосходит две другие составляющие, основное внимание при оптимизации следует уделять **уменьшению времени поиска**.

**Методы оптимизации:**
1. **Алгоритмы планирования** запросов к диску (SCAN, LOOK и др.)
2. **Размещение данных** на диске (близкие файлы на одном цилиндре)
3. **Кэширование** часто используемых данных в памяти
4. **Дефрагментация** для уменьшения перемещений головок

---

## Оптимизация физических параметров диска

### Переменное количество секторов на дорожку

![[OS 95.png]]

#### Проблема постоянного количества секторов
**Традиционный подход:**
- Все дорожки содержат одинаковое количество секторов
- Количество определяется **внутренними дорожками** (самыми короткими)

**Недостаток:**
- Внешние дорожки (более длинные) используются **неэффективно**
- Много неиспользуемого пространства на внешних дорожках

#### Современное решение: Зонирование (Zone Bit Recording, ZBR)
**Концепция:**
Диск разбивается на **зоны**, в каждой зоне дорожки содержат разное количество секторов:
- **Внешние зоны** — больше секторов на дорожку
- **Внутренние зоны** — меньше секторов на дорожку

**Преимущества:**
- **Увеличение ёмкости** диска на 20-30%
- **Более эффективное** использование поверхности
- **Выше скорость передачи** на внешних дорожках

**Недостаток:**
- **Усложнение адресации** — нужно учитывать зону
- **Разная скорость** передачи для разных зон

### Перекос цилиндров (Cylinder Skew)

![[OS 96.png]]
#### Проблема последовательного чтения
**Ситуация:**
Процесс последовательно читает секторы, расположенные на соседних дорожках.

**Проблема без перекоса:**
1. Головка читает последний сектор на дорожке N
2. Головка **перемещается** на дорожку N+1
3. За время перемещения **первый сектор** дорожки N+1 уже **прошёл** под головкой
4. Нужно ждать **полный оборот** диска

**Решение: Cylinder Skew**
**Концепция:**
Нумерация секторов на соседних дорожках **смещена** на несколько позиций.

**Механизм:**
- Первый сектор дорожки N+1 расположен **не напротив** первого сектора дорожки N
- Он смещён на величину, соответствующую времени перемещения головки
- После перемещения головки сектор **как раз подходит** под головку

**Преимущество:**
> Последовательное чтение через границы дорожек происходит **без дополнительных задержек** на ожидание вращения.

### Чередование секторов (Sector Interleaving)

![[OS 97.png]]

#### Проблема последовательного чтения на одной дорожке
**Ситуация (на старых системах):**
1. Контроллер читает сектор N
2. Контроллер **передаёт данные** в память (занимает время)
3. За это время сектор N+1 уже **прошёл** под головкой
4. Нужно ждать **почти полный оборот**

#### Решение: Interleaving
**Концепция:**
Физически последовательные секторы имеют **несмежные логические номера**.

**Примеры коэффициентов чередования:**

**Interleaving 1:1 (нет чередования):**
```
Физический порядок: 0, 1, 2, 3, 4, 5, 6, 7
Логический порядок:  0, 1, 2, 3, 4, 5, 6, 7
```

**Interleaving 2:1:**
```
Физический порядок: 0, 1, 2, 3, 4, 5, 6, 7
Логический порядок:  0, 4, 1, 5, 2, 6, 3, 7
```


**Interleaving 3:1:**
```
Физический порядок: 0, 1, 2, 3, 4, 5, 6, 7, 8
Логический порядок:  0, 3, 6, 1, 4, 7, 2, 5, 8
```

**Преимущество:**
После обработки сектора N следующий нужный сектор (N+1) **как раз находится** под головкой.

**Современное состояние:**
> На современных системах с **быстрыми контроллерами** и **буферами** чередование обычно **не требуется** (используется 1:1).

---

## Форматирование диска

### Низкоуровневое форматирование (Low-Level Format)
#### Назначение
**Низкоуровневое форматирование** — процесс создания физической структуры секторов на диске.

**Выполняется:**
- Обычно **на заводе** при производстве диска
- Может выполняться **специальными утилитами** (редко)

#### Структура сектора после форматирования
![[OS 98.png]]

Каждый сектор состоит из нескольких областей:
##### 1. Преамбула (Preamble)
**Содержит:**
- **Синхронизирующую последовательность** битов
- Позволяет контроллеру **определить начало** сектора

##### 2. Заголовок (Header)
**Содержит:**
- **Определённую последовательность битов** для распознавания сектора аппаратурой
- **Номер цилиндра**
- **Номер головки** (поверхности)
- **Номер сектора**
- Размер сектора
- Информацию о состоянии сектора

**Функция:**
- Обеспечивает **идентификацию** сектора
- Позволяет контроллеру **проверить**, что головка находится в нужном месте

##### 3. Данные (Data)

**Содержит:**
- **Собственно данные** (обычно 512 байт или 4096 байт)
- Это **полезная область**, доступная для ОС и приложений

##### 4. ECC (Error Correcting Code)

**Содержит:**
- **Контрольную сумму** для обнаружения ошибок
- **Корректирующие коды** для исправления ошибок

**Функции:**
- **Обнаружение** битовых ошибок при чтении
- **Исправление** небольших ошибок автоматически

**Типичные возможности:**
- Обнаружение ошибок до 11 бит
- Исправление ошибок до 5 бит

##### 5. Промежуток (Gap)
**Содержит:**
- Пустое пространство между секторами
- Компенсирует **неточности** в позиционировании
- Даёт время на **переключение** режима чтения/записи

#### Особенности низкоуровневого форматирования
**Важно:**
- Уничтожает **все данные** на диске безвозвратно
- Может выявить **дефектные секторы** и пометить их как bad blocks
- На современных дисках обычно **не требуется** (заводское форматирование)

---
## Разделы диска (Partitions)

![[OS 78.png]]
### Концепция разделов
#### Что такое раздел?
**Раздел (Partition)** — логически независимая часть физического диска, которую операционная система рассматривает как **отдельный диск**.

**Зачем нужны разделы:**
1. **Установка нескольких ОС** на один диск
2. **Разделение данных** (системные файлы отдельно от пользовательских)
3. **Организация файловых систем** (разные разделы — разные ФС)
4. **Безопасность и изоляция** данных

### Главная загрузочная запись (MBR)
#### Master Boot Record (MBR)
**MBR** — первый сектор диска (сектор 0, цилиндр 0, головка 0), содержащий важную информацию для загрузки.

**Расположение:** 
Самый первый сектор физического диска (LBA 0).

**Размер:** 512 байт

#### Структура MBR
**MBR состоит из трёх частей:**
##### 1. Код загрузчика (Bootstrap Code)
**Размер:** 446 байт
**Функция:**
- Содержит **программный код**, выполняемый при загрузке компьютера
- Код **читает таблицу разделов**
- Находит **активный раздел**
- **Загружает** загрузочный сектор активного раздела
- **Передаёт управление** загрузчику ОС

##### 2. Таблица разделов (Partition Table)
**Размер:** 64 байта (4 записи по 16 байт)

**Содержит:**
- Информацию о **до 4 первичных разделов**
- Для каждого раздела записываются:
  - **Статус** (активный/неактивный)
  - **Начальный сектор** раздела (номер CHS или LBA)
  - **Размер** раздела
  - **Тип раздела** (тип файловой системы)

**Запись о разделе (16 байт):**
- 1 байт — флаг загрузки (0x80 = активный, 0x00 = неактивный)
- 3 байта — начальный CHS-адрес
- 1 байт — тип раздела (0x83 = Linux, 0x07 = NTFS, и т.д.)
- 3 байта — конечный CHS-адрес
- 4 байта — начальный LBA-адрес
- 4 байта — размер раздела в секторах

##### 3. Сигнатура (Signature)
**Размер:** 2 байта

**Значение:** 0x55AA (магическое число)

**Функция:**
- Идентифицирует **корректный MBR**
- Используется BIOS для **проверки** валидности загрузочного сектора

### Ограничения MBR
**Недостатки схемы MBR:**
1. **Максимум 4 первичных раздела**
   - Можно обойти, используя расширенные разделы (Extended Partition)
   
2. **Ограничение размера диска**
   - Максимум **2 ТБ** (32-битная адресация секторов)
   
3. **Отсутствие резервных копий**
   - Повреждение MBR делает диск **недоступным**

### GPT (GUID Partition Table)
**Современная альтернатива MBR:**

**Преимущества GPT:**
- Поддержка дисков **больше 2 ТБ**
- До **128 разделов** (стандарт Windows)
- **Резервные копии** таблицы разделов
- **CRC32 контрольные суммы** для целостности
- Использование **GUID** для идентификации разделов
---
## Высокоуровневое форматирование
### Назначение высокоуровневого форматирования
**Высокоуровневое форматирование** — процесс создания файловой системы на разделе диска.

**Выполняется:**
- После создания разделов
- Перед использованием раздела для хранения файлов
- С помощью утилит ОС (format в Windows, mkfs в Linux)

### Создаваемые структуры на диске
#### 1. Загрузочный блок (Boot Block)
**Назначение:**
Содержит информацию, необходимую для **загрузки ОС** с этого раздела.

**Особенности:**
- Обычно это **первый блок** файловой системы
- Если раздел не содержит ОС, блок будет **пустым**
- Содержит код для загрузки ядра ОС

**Названия в разных ФС:**
- **UFS:** boot block
- **NTFS:** partition boot sector
- **ext4:** boot sector

#### 2. Блок управления томом/разделом (Volume Control Block)
**Назначение:**
Содержит **детальную информацию** о разделе (метаданные файловой системы).

**Содержит:**
- **Количество блоков** в файловой системе
- **Размер блока** (обычно 4 КБ)
- **Счётчик свободных блоков**
- **Указатель на список** свободных блоков
- **Счётчик свободных FCB** (индексных дескрипторов)
- **Указатель на список** свободных FCB
- Информацию о **монтировании** (метка тома, UUID)
- Размер и расположение других структур

**Названия в разных ФС:**
- **UFS:** superblock
- **NTFS:** master file table (MFT)
- **ext4:** superblock
- **FAT:** boot sector + FAT

**Критичность:**
> Повреждение VCB делает файловую систему **недоступной**! Поэтому обычно хранятся **резервные копии**.

#### 3. Структура директорий (Directory Structure)
**Назначение:**
Организует файлы в **иерархическую структуру** каталогов.

**На одну файловую систему создаётся одна структура директорий.**

**Содержит для каждого файла/каталога:**

**В UFS:**
- **Имя файла**
- **Номер индексного узла** (inode)

**В NTFS:**
- Содержится в **master file table**
- Более сложная структура

**Функции:**
- **Поиск** файлов по имени
- **Навигация** по иерархии каталогов
- **Организация** пространства имён

#### 4. FCB — File Control Block
**Назначение:**
Блок управления файлом — структура, содержащая **детальную информацию о файле**.

**Один FCB на каждый файл в системе.**

**Содержит:**
- **Права доступа** (rwx для owner, group, others)
- **Владелец** файла (UID, GID)
- **Размер** файла
- **Временные метки:**
  - Время создания
  - Время последнего доступа
  - Время последней модификации
  - Время изменения метаданных
- **Размещение блоков данных** на диске
  - Прямые указатели
  - Косвенные указатели (одно-, двух-, трёхуровневые)
- **Количество жёстких ссылок**
- **Тип файла** (обычный, каталог, символическая ссылка, устройство)

**Названия в разных ФС:**
- **UFS:** inode (index node)
- **NTFS:** запись в master file table (со структурой реляционной БД, одна строка на файл)
- **ext4:** inode

### Структуры в памяти
Для эффективной работы с файловой системой ОС создаёт **несколько структур в оперативной памяти**:
#### 1. Таблица смонтированных файловых систем (Mount Table)
**Содержит:**
- Информацию о всех **смонтированных** файловых системах
- **Точки монтирования** (mount points)
- Указатели на VCB в памяти
- Тип файловой системы

**Функция:**
- Позволяет ОС **найти** нужную файловую систему по пути

#### 2. Кэш структуры директорий
**Содержит:**
- Информацию о **недавно использованных** директориях
- **Указатели** на структуры на диске
- **Результаты** недавних поисков файлов

**Функция:**
- **Ускорение** поиска файлов
- **Снижение** обращений к диску

#### 3. Системная таблица открытых файлов (System-Wide Open File Table)
**Содержит:**
- **Копии FCB** открытых файлов
- **Режим доступа** (чтение, запись)
- **Указатель** на текущую позицию в файле
- **Счётчик ссылок** (сколько процессов открыло файл)
- Информацию о **блокировках** файла

**Одна запись на каждый уникально открытый файл в системе.**

#### 4. Таблица открытых файлов процесса (Per-Process Open File Table)
**Содержит:**
- **Дескрипторы файлов** (file descriptors) для процесса
- **Указатели** на записи в системной таблице открытых файлов
- **Флаги** открытия (O_RDONLY, O_WRONLY, O_RDWR, O_APPEND и др.)

**Каждый процесс имеет свою таблицу.**

**Связь:**
```
Процесс → Таблица процесса → Системная таблица → FCB на диске
```

---

## Операции с файловой системой
### Создание файла
**Последовательность действий:**
1. **Поиск** свободного FCB в файловой системе
2. **Выделение** FCB для нового файла
3. **Заполнение** FCB метаданными:
   - Владелец = текущий пользователь
   - Размер = 0
   - Права доступа = по умолчанию
   - Временные метки = текущее время
4. **Создание записи** в директории (имя + номер FCB)
5. **Обновление** VCB (уменьшение счётчика свободных FCB)

### Открытие файла (open)
**Последовательность действий:**
1. **Поиск** файла в структуре директорий
2. **Получение** номера FCB из записи директории
3. **Чтение FCB** с диска
4. **Проверка** прав доступа
5. **Создание записи** в системной таблице открытых файлов
6. **Создание записи** в таблице открытых файлов процесса
7. **Возврат** дескриптора файла процессу

**После открытия:**
- FCB **кэширован** в памяти
- Дальнейшие операции **не требуют** поиска по директориям

### Чтение/запись данных (read/write)
**Последовательность действий:**
1. Процесс передаёт **дескриптор файла**
2. ОС находит запись в **таблице процесса**
3. Через указатель находит запись в **системной таблице**
4. Получает **FCB** и **текущую позицию** в файле
5. Вычисляет **номера блоков** на диске
6. Выполняет **операцию ввода-вывода** через драйвер диска
7. **Обновляет** позицию в файле
8. **Обновляет** временные метки в FCB

### Закрытие файла (close)
**Последовательность действий:**
1. **Удаление записи** из таблицы открытых файлов процесса
2. **Уменьшение счётчика** ссылок в системной таблице
3. Если счётчик = 0:
   - **Запись изменённого FCB** на диск
   - **Удаление записи** из системной таблицы
   - **Освобождение** кэшированных блоков данных
---
## Планирование дисковых операций
### Необходимость планирования
**Проблема:**
Когда несколько процессов одновременно хотят выполнить операции с диском, **в какой последовательности** их обслуживать?

**Цели планирования:**
1. **Минимизация** времени поиска (seek time)
2. **Справедливость** обслуживания запросов
3. **Предотвращение** голодания (starvation)
4. **Максимизация** пропускной способности

### Место планирования
**Задача планирования** использования диска может возлагаться на:
1. **Базовую подсистему ввода-вывода**
   - Общие алгоритмы для всех устройств
   - Не учитывает специфику устройства

2. **Драйвер устройства**
   - Учитывает **детали внутреннего функционирования** диска
   - Более **эффективные алгоритмы**
   - Для этого в интерфейс драйвера добавляется функция **strategy**

> **Современный подход:** Планирование обычно реализуется **в драйвере** или на уровне **подсистемы блочных устройств** ядра.