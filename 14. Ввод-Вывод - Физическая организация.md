#Operating_Systems #OS_Input_Output
## Введение в системы ввода-вывода
### Работа вычислительной системы
Функционирование любой вычислительной системы обычно сводится к выполнению **двух основных видов работы**:

1. **Обработка информации** — выполнение команд процессора над данными
2. **Операции ввода-вывода (I/O)** — обмен данными между памятью и внешними устройствами

**Организация в рамках модели процессов:**
- Вся работа в вычислительной системе организована как набор процессов
- Процессы занимаются как обработкой информации, так и выполнением операций ввода-вывода
- Напоминание: **CPU burst** (интервал работы процессора) и **I/O burst** (интервал ввода-вывода) чередуются в жизненном цикле процесса
---
## Точки зрения на обработку информации и I/O
Содержание понятий "обработка информации" и "операции ввода-вывода" **зависит от точки зрения**, с которой мы смотрим на вычислительную систему.

### С точки зрения программиста
**Обработка информации:**
- Выполнение команд процессора над данными, лежащими в памяти **независимо от уровня иерархии**
- Включает работу с данными в:
  - Регистрах процессора
  - Кэш-памяти
  - Оперативной памяти (RAM)
  - Вторичной памяти (диски)

**Операции ввода-вывода:**
- Обмен данными между памятью и **внешними устройствами**
- Внешние устройства: магнитные ленты, диски, монитор, клавиатура, таймер и т.д.

### С точки зрения операционной системы
**Обработка информации:**
- **Только** операции, совершаемые процессором над данными, находящимися в памяти **на уровне иерархии не ниже оперативной памяти**
- Данные должны находиться в регистрах, кэше или оперативной памяти

**Операции ввода-вывода:**
- **Всё остальное** относится к операциям ввода-вывода
- Чтобы совершить операции над данными, временно расположенными во вторичной памяти:
  1. ОС сначала производит **подкачку данных** в оперативную память
  2. Только затем процессор совершает необходимые действия

> **Ключевое отличие:** Для ОС работа с диском — это операция I/O, для программиста — это может восприниматься как работа с памятью.
---
## Внешние устройства ввода-вывода
### Разнообразие устройств
Существует огромное множество устройств, которые могут взаимодействовать с процессором и памятью:

**Примеры устройств:**
- Таймер
- Жёсткие диски (HDD), твердотельные накопители (SSD)
- Клавиатура
- Дисплеи, мониторы
- Мышь, трекболы, джойстики
- Модемы, сетевые карты
- Принтеры, сканеры

**Расположение устройств:**
- Часть устройств встроена внутрь корпуса компьютера
- Часть вынесена за пределы и общается через различные линии связи:
  - Кабельные (USB, HDMI, DisplayPort)
  - Оптоволоконные
  - Радиорелейные
  - Спутниковые

### «Зоопарк» устройств — характеристики и различия
Устройства ввода-вывода обладают чрезвычайным **разнообразием характеристик**:
#### 1. Скорость обмена информацией
- **От нескольких байт в секунду** (клавиатура — ~10 байт/с)
- **До нескольких гигабайт в секунду** (современные сетевые карты, NVMe SSD — до 7 ГБ/с)

#### 2. Разделяемость
- **Разделяемые устройства** — могут использоваться параллельно несколькими процессами (жёсткий диск, сетевая карта)
- **Эксклюзивные устройства** — требуют монопольного захвата процессом (принтер, магнитофон)

#### 3. Сохранение информации
- **Устройства с памятью** — запоминают выведенную информацию для последующего ввода (диски, ленты)
- **Устройства без памяти** — не обладают этой функцией (монитор, принтер)

#### 4. Формы доступа к сохранённой информации
- **Последовательный доступ** — данные доступны только в жёстко заданном порядке (магнитная лента)
- **Прямой доступ** — возможность находить и передавать только необходимую порцию данных (диск)

#### 5. Единица передачи данных
- **Символьные устройства** — передают данные только по одному байту последовательно (клавиатура, мышь, модем, терминал)
- **Блочные устройства** — передают блок байтов как единое целое (магнитные и оптические диски)

#### 6. Направление передачи данных
- **Устройства только для ввода** (клавиатура, мышь, сканер)
- **Устройства только для вывода** (монитор, принтер, динамики)
- **Устройства для ввода и вывода** (диски, сетевые карты, сенсорные экраны)

#### 7. Применение
- Каждое действие устройства оказывает влияние на программное обеспечение и стратегии ОС
- Например, диск, используемый для хранения файлов или для страниц виртуальной памяти, требует различного программного обеспечения

#### 8. Сложность управления
- **Простой интерфейс** — принтер требует относительно простого управления
- **Сложный интерфейс** — для диска требуется намного более сложное управление
- Влияние этих отличий на ОС сглаживается усложнением контроллеров ввода-вывода

#### 9. Представление данных
- Различные устройства используют разные схемы кодирования данных
- Различная кодировка символов (ASCII, Unicode, EBCDIC)
- Различный контроль чётности

#### 10. Условия ошибок
- Природа ошибок резко отличается при переходе от одного устройства к другому
- Различные способы сообщения об ошибках
- Различные последствия и возможные ответы на ошибки
---
## Классификация внешних устройств
### Классификация по взаимодействию
#### 1. Устройства, работающие с пользователем
**Назначение:** Связь пользователя с компьютером

**Примеры:**
- Принтеры
- Дисплеи
- Клавиатура
- Манипуляторы (мышь, трекбол, джойстики)
- Сенсорные экраны
- Графические планшеты

#### 2. Устройства, работающие с компьютером
**Назначение:** Связь с электронным оборудованием

**Примеры:**
- Дисковые устройства (HDD, SSD)
- Устройства с магнитными лентами
- Датчики
- Контроллеры
- Аналого-цифровые преобразователи (АЦП)
- Цифро-аналоговые преобразователи (ЦАП)

#### 3. Коммуникационные устройства
**Назначение:** Связь с удалёнными устройствами

**Примеры:**
- Модемы
- Адаптеры цифровых линий
- Сетевые карты (Ethernet, Wi-Fi)
- Bluetooth-адаптеры

### Систематизация по типу интерфейса
Устройства обычно разделяют по **преобладающему типу интерфейса**:
#### 1. Символьные устройства
- Клавиатура
- Модем
- Терминал
- Последовательные порты

#### 2. Блочные устройства
- Магнитные диски (HDD)
- Оптические диски (CD, DVD, Blu-ray)
- Твердотельные накопители (SSD)
- Магнитные ленты

#### 3. Сетевые устройства
- Сетевые карты (NIC)
- Wi-Fi адаптеры
- Модемы

#### 4. Все остальные устройства
- Таймеры
- Графические дисплеи
- Телевизионные устройства
- Видеокамеры
- Звуковые карты

> **Примечание:** Такое деление является весьма условным. Цель классификации — иллюстрация того, что устройства могут быть разделены на группы по выполняемым ими функциям, и понимание функций драйверов и интерфейса между ними и базовой подсистемой ввода-вывода.

---
## Физическая реализация устройств
### Структура устройств ввода-вывода
Устройства ввода-вывода, как правило, состоят из **двух основных частей**:

1. **Электромеханическая часть** — собственно устройство (физическое устройство)
2. **Электронная часть** — контроллер (адаптер)

**Форма исполнения:**
- Обычно выполняются в форме **отдельных модулей**
- В персональных компьютерах контроллер принимает форму **платы расширения**
- Плата вставляется в слот расширения на материнской плате
- Плата имеет разъём, к которому подключается кабель, ведущий к самому устройству

**Множественное управление:**
- Многие контроллеры способны управлять **несколькими идентичными устройствами**
- Например: контроллер IDE может управлять 2 устройствами, контроллер SCSI — до 7-15 устройств

![[OS 82.png]]

---
## Стандартизация физического соединения
### Стандартные интерфейсы
**Интерфейс между контроллером и устройством** является стандартом:
- **Официальные стандарты:** ANSI, IEEE, ISO
- **Фактические стандарты:** широко принятые в индустрии

**Преимущества стандартизации:**
- Различные компании могут выпускать **отдельно контроллеры и устройства**
- Совместимость устройств от разных производителей
- Снижение стоимости за счёт конкуренции

**Примеры стандартных интерфейсов:**
- **IDE (Integrated Drive Electronics) / ATA** — старый стандарт для подключения дисков
- **SCSI (Small Computer System Interface)** — высокопроизводительный интерфейс
- **SATA (Serial ATA)** — современный последовательный интерфейс для дисков
- **USB (Universal Serial Bus)** — универсальная последовательная шина
- **PCIe (PCI Express)** — высокоскоростная шина расширения

### Характер интерфейса контроллер-устройство
**Интерфейс между контроллером и устройством:**
- Часто является интерфейсом **очень низкого уровня**
- Очень специфичен, зависит от типа внешнего устройства

**Пример: видеоконтроллер**
- Считывает из памяти байты, содержащие символы для отображения
- Формирует сигналы управления лучом электронной трубки (для ЭЛТ-мониторов)
- Генерирует сигналы строчной и кадровой развёртки
- Управляет пикселями на современных цифровых дисплеях

### Взаимодействие контроллера с драйвером
**Драйвер устройства:**
- Каждый контроллер взаимодействует с **драйвером** — системным программным модулем
- Драйвер предназначен для управления данным устройством

**Драйвер** - часть подсистемы ввода-вывода ОС:
- Отвечает за **инициализацию устройства**
- Обеспечивает **обмен данными** между устройством и остальной частью ОС
- Обрабатывает **ошибки устройства**
- Предоставляет **интерфейс высокого уровня** для других частей ОС
- Абстрагирует детали аппаратной реализации устройства


**Средства взаимодействия контроллера с драйвером:**
#### 1. Регистры контроллера
- Для работы с драйвером контроллер имеет **несколько регистров**
- Каждому управляющему регистру назначается **номер порта ввода-вывода**

#### 2. Буфер данных
- Контроллер может иметь буфер данных
- Из этого буфера ОС может **читать данные**
- В этот буфер ОС может **записывать данные**

**Использование регистров контроллера:**
Используя регистры контроллера, ОС может:
1. **Узнать состояние устройства** (например, готово ли оно к работе)
2. **Выдавать команды управления** устройством:
   - Принять или передать данные
   - Включиться или выключиться
   - Изменить режим работы
   - Выполнить специфичные для устройства операции
---
## Система ввода-вывода операционной системы
### Определение и структура
**Система ввода-вывода** — это часть кода ОС, которая:
- Получает **запросы ввода-вывода** от процессов пользовательского режима
- Передаёт их в **преобразованном виде** устройствам ввода-вывода

**Компоненты между пользователем и аппаратурой:**
- Сервисы пользовательского режима (системные вызовы)
- Операционная система
- Подсистема ввода-вывода ОС
- Драйверы устройств
- Контроллеры устройств
- Само устройство ввода-вывода

![[OS 91.png]]

![[OS 83.png]]

---

## Назначение системы ввода-вывода
**Основная задача:**
Обмен данными между пользователями, приложениями и периферийными устройствами компьютера.

**Историческое значение:**
- Собственно, для выполнения этой задачи были разработаны **первые системные программы**
- Эти программы послужили **прототипами операционных систем**
- Первые ОС были, по сути, системами управления вводом-выводом

---
## Функции системы ввода-вывода
Современная система ввода-вывода выполняет множество функций:
### 1. Организация параллельной работы
- Организация **параллельной работы** устройств ввода-вывода и процессора
- Устройства работают асинхронно, независимо от процессора
- Позволяет процессору выполнять вычисления во время операций I/O
### 2. Согласование скоростей и кэширование
- **Согласование скоростей обмена** между быстрым процессором и медленными устройствами
- **Кэширование данных** для повышения производительности
- Буферизация для сглаживания пиковых нагрузок
### 3. Разделение ресурсов
- **Разделение устройств** между процессами (выполняющимися программами)
- **Разделение данных** между процессами
- Обеспечение изоляции и защиты данных разных процессов
### 4. Логический интерфейс
- Обеспечение **удобного логического интерфейса** между устройствами и остальной частью системы
- Абстракция от деталей физической реализации
- Унификация доступа к различным устройствам
### 5. Поддержка драйверов
- Поддержка **широкого спектра драйверов**
- Возможность **простого включения** в систему нового драйвера
- **Динамическая загрузка и выгрузка** драйверов без перезагрузки ОС
### 6. Поддержка файловых систем
- Поддержка **нескольких различных файловых систем** одновременно
- Например: NTFS, FAT32, exFAT, ext4 на одном компьютере
### 7. Режимы операций
- Поддержка **синхронных операций** ввода-вывода (программа ждёт завершения)
- Поддержка **асинхронных операций** ввода-вывода (программа продолжает работу)
---
## Эволюция систем ввода-вывода
Системы ввода-вывода прошли длительный путь эволюции:
### Этап 1: Прямое управление процессором
- **Процессор непосредственно управляет** периферийным устройством
- Процессор выполняет всю работу по управлению устройством
- Самый примитивный и неэффективный способ

### Этап 2: Программируемый ввод-вывод без прерываний
- Устройство управляется **контроллером**
- Процессор использует **программируемый ввод-вывод** без прерываний
- Переход к **абстракции интерфейса** ввода-вывода
- Процессор периодически проверяет готовность устройства (polling)

**Polling** — метод, при котором процессор регулярно опрашивает устройство для проверки его состояния, что приводит к потере времени на ожидание.

### Этап 3: Ввод-вывод, управляемый прерываниями
- Использование **контроллера прерываний**
- Устройство сигнализирует процессору о готовности
- Процессор не тратит время на ожидание в цикле

### Этап 4: Прямой доступ к памяти (DMA)
- Использование **модуля (канала) прямого доступа к памяти**
- **Перемещение данных в память** (из неё) **без применения процессора**
- Процессор освобождается от рутинной работы по передаче данных

**Модуль DMA** — специализированный аппаратный компонент, который позволяет устройствам ввода-вывода напрямую обмениваться данными с основной памятью, минуя центральный процессор.

### Этап 5: Специализированный процессор I/O
- Использование **отдельного специализированного процессора** ввода-вывода
- Управляется центральным процессором
- Выполняет сложные операции ввода-вывода самостоятельно

**Специализированный процессор I/O** — отдельный процессор, предназначенный для управления операциями ввода-вывода, освобождая центральный процессор от этих задач.
### Этап 6: Автономный компьютер I/O
- Использование **отдельного компьютера** для управления устройствами ввода-вывода
- **Минимальное вмешательство** центрального процессора
- Современные сетевые карты с собственными процессорами

**Общая тенденция эволюции:**
> Проследив описанный путь развития устройств ввода-вывода, можно заметить, что **вмешательство процессора в функции ввода-вывода становится всё менее заметным**. Центральный процессор всё больше освобождается от задач, связанных с вводом-выводом, что приводит к **повышению общей производительности** компьютерной системы.

---
## Три способа организации ввода-вывода
### 1. Программируемый ввод-вывод (Programmed I/O)
#### Принцип работы:
1. Процессор встречает команду, связанную с вводом-выводом
2. Процессор **выполняет её**, посылая соответствующие команды контроллеру
3. Контроллер выполняет требуемое действие
4. Контроллер устанавливает соответствующие биты в **регистрах состояния**
5. Контроллер **не посылает сигналов прерываний**
6. Процессор **периодически проверяет** состояние модуля ввода-вывода (polling)

#### Характеристики:
- Процессор **непосредственно управляет** операциями ввода-вывода
- Включает опознание состояния устройства, пересылку команд чтения-записи и передачу данных
- Процессор посылает необходимые команды и **переводит текущий процесс в состояние ожидания**

#### Недостатки:
- **Большие потери процессорного времени**, связанные с управлением вводом-выводом
- Процессор постоянно занят опросом устройств
- Низкая эффективность при медленных устройствах

#### Применение:
- Простые встроенные системы
- Устройства с очень высокой скоростью обмена
- Ситуации, когда время отклика критично

---
### 2. Ввод-вывод, управляемый прерываниями (Interrupt-Driven I/O)
#### Принцип работы:
1. Процессор посылает необходимые команды контроллеру ввода-вывода
2. Процессор **продолжает выполнять** текущий процесс, если нет необходимости в ожидании
3. Если требуется ожидание, текущий процесс **приостанавливается** до получения сигнала прерывания (переводит в режим ожидания). Процессор переключается на **выполнение другого процесса**
4. При завершении операции устройство генерирует **прерывание**
5. Процессор проверяет наличие прерываний **в конце каждого цикла** выполняемых команд
6. При обнаружении прерывания процессор **сохраняет контекст** текущего процесса
7. Процессор **переходит к обработчику прерывания**, который взаимодействует с контроллером для завершения операции ввода-вывода
8. После завершения обработки прерывания процессор **восстанавливает контекст** приостановленного процесса и продолжает его выполнение

**Цикл выполнения команд** - период времени, в течение которого процессор выполняет одну или несколько команд текущего процесса до проверки прерываний.
#### Характеристики:
- **Намного эффективнее**, чем программируемый ввод-вывод
- Исключается ненужное ожидание с бесполезным простоем процессора
- Процессор может выполнять полезную работу во время операций I/O

#### Недостатки:
- Ввод-вывод всё ещё потребляет **значительное количество процессорного времени**
- Каждое слово, которое передаётся из памяти в контроллер или обратно, **должно пройти через процессор**
- Процессор занят копированием данных между памятью и контроллером

#### Применение:
- Символьные устройства (клавиатура, мышь)
- Устройства с небольшим объёмом передаваемых данных
- Большинство современных устройств
---
### 3. Прямой доступ к памяти — DMA (Direct Memory Access)
#### Принцип работы:
1. **Специальный модуль DMA** управляет обменом данных между основной памятью и контроллером
2. Процессор посылает **запрос на передачу блока данных** модулю DMA
3. Модуль DMA **самостоятельно передаёт данные** между памятью и устройством
4. Прерывание процессора происходит **только после передачи всего блока данных**

#### Характеристики:
- **Максимально эффективный** способ организации ввода-вывода
- Процессор полностью освобождается от рутинной работы по передаче данных
- Одно прерывание на весь блок данных вместо прерываний на каждое слово

#### Преимущества:
- Минимальная нагрузка на процессор
- Высокая скорость передачи данных
- Процессор может выполнять вычисления параллельно с передачей данных

#### Применение:
- Блочные устройства (диски, SSD)
- Устройства с большим объёмом передаваемых данных
- Высокопроизводительные системы

#### Компоненты DMA:
- **Контроллер DMA** — управляет передачей данных
- **Регистры DMA:**
  - Адрес источника данных
  - Адрес назначения
  - Счётчик байтов для передачи
  - Регистр управления и состояния

![[OS 89.png]]

---
## Физические принципы организации ввода-вывода
### Общие принципы
**Разнообразие конфигураций:**
- Конкретный набор устройств и способы их подключения определяются:
  - Целями функционирования вычислительной системы
  - Желаниями пользователя
  - Финансовыми возможностями

**Универсальные принципы:**
> Несмотря на всё многообразие устройств, управление их работой и обмен информацией с ними строятся на **относительно небольшом количестве принципов**.
---
## Архитектура подключения устройств
### Локальная магистраль
**Простейший случай:**
- Процессор, память и многочисленные внешние устройства связаны большим количеством **электрических соединений — линий**
- Эти линии в совокупности называются **локальной магистралью компьютера** (System Bus)

**Группировка линий в шины:**
- Линии, служащие для передачи сходных сигналов и выполняющие сходные функции, группируются в **шины**
- Количество линий в шине называется **разрядностью (шириной) шины**

**Значение разрядности:**
- **Ширина адресной шины** определяет максимальный размер оперативной памяти
  - Например: 32-битная адресная шина → максимум 4 ГБ адресного пространства
  - 64-битная адресная шина → максимум 16 эксабайт
- **Ширина шины данных** определяет максимальный объём информации, передаваемой за один раз
  - Например: 64-битная шина данных → 8 байт за одну операцию
- **Ширина шины управления** определяет количество различных управляющих сигналов
  - Например: 16 линий управления → 16 различных сигналов

![[OS 86.png]]

---
### Понятие шины
**Шина — это не только провода:**
Понятие шины включает в себя:
1. **Набор проводников** — физические линии для передачи сигналов
2. **Набор жёстко заданных протоколов** — правила передачи сообщений с помощью электрических сигналов

**В современных компьютерах выделяют минимум три шины:**
#### 1. Шина данных (Data Bus)
**Назначение:**
- Передача информации между процессором и памятью
- Передача информации между процессором и устройствами ввода-вывода
- Передача информации между памятью и внешними устройствами

**Состав:**
- Линии данных

**Характеристики:**
- Двунаправленная (bidirectional)
- Разрядность: обычно 32 или 64 бита

#### 2. Адресная шина (Address Bus)
**Назначение:**
- Задание адреса ячейки памяти, участвующей в обмене информацией
- Указание устройства ввода-вывода, участвующего в обмене

**Состав:**
- Линии адреса

**Характеристики:**
- Однонаправленная (от процессора)
- Разрядность определяет размер адресного пространства

#### 3. Шина управления (Control Bus)
**Назначение:**
- Определение поведения локальной магистрали
- Управление операциями обмена

**Состав:**
- Линии управления локальной магистралью
- Линии состояния магистрали

**Примечание:**
В некоторых архитектурных решениях линии состояния выносятся в отдельную **шину состояния** (Status Bus).

**Сигналы шины управления:**
- Чтение/запись (Read/Write)
- Память/I/O (Memory/I/O Select)
- Готовность (Ready)
- Запрос шины (Bus Request)
- Подтверждение (Acknowledge)
- Тактовые сигналы (Clock)
- Сброс (Reset)

---
### Операции обмена через шину
#### Пример: передача информации из процессора в память
**Необходимые действия (в простейшем случае):**
**Шаг 1: Выставление адреса**
- На **адресной шине** процессор выставляет сигналы, соответствующие адресу ячейки памяти
- Адрес указывает, **куда** будет осуществляться передача информации

**Шаг 2: Выставление данных**
- На **шину данных** процессор выставляет сигналы, соответствующие информации
- Эти данные должны быть записаны в память

**Шаг 3: Активация управляющих сигналов**
- На **шину управления** выставляются сигналы, соответствующие:
  - Операции **записи** (Write)
  - Работе с **памятью** (Memory Select)
- Это приведёт к занесению необходимой информации по требуемому адресу
---
### Архитектура: Порты ввода-вывода
#### Понятие порта
**Определение:**
- Внешние устройства **разнесены пространственно**
- Они подключаются к локальной магистрали в одной точке или множестве точек
- Эти точки подключения получили название **портов ввода-вывода**

**Адресация портов:**
- Точно так же, как ячейки памяти отображаются в адресное пространство памяти
- Порты ввода-вывода можно отобразить в другое адресное пространство — **адресное пространство ввода-вывода**
- Каждый порт получает свой **номер или адрес** в этом пространстве

![[OS 87.png]]

---
### Архитектура: Прямое отображение в память (Memory-Mapped I/O)
#### Условия применения
**Возможность прямого отображения** возникает когда:
1. **Адресное пространство памяти задействовано не полностью**
   - Остались адреса, которым не соответствуют физические ячейки памяти
   - Есть «свободное место» в адресном пространстве

2. **Протоколы совместимы**
   - Протоколы работы с внешним устройством совместимы с протоколами работы с памятью
   - Устройство может «прикинуться» памятью

#### Реализация
- Часть портов ввода-вывода может быть **отображена непосредственно в адресное пространство памяти**
- **Пример:** видеопамять дисплеев
- При таком отображении эти порты уже не принято называть портами

#### Преимущества
**Механизмы защиты:**
- При отображении портов в адресное пространство памяти можно задействовать **существующие механизмы защиты памяти**
- Не требуется организация специальных защитных устройств
- Используются те же таблицы страниц, сегменты и права доступа

**Упрощение программирования:**
- Доступ к устройствам через обычные команды работы с памятью
- Не нужны специальные команды IN/OUT

---
### Операции обмена при наличии порта
#### Случай: порт в адресном пространстве ввода-вывода
**Для передачи данных в порт необходимо:**
**Шаг 1: Выставление адреса порта**
- На **адресной шине** процессор выставляет сигналы, соответствующие адресу порта
- Адрес берётся из **адресного пространства ввода-вывода**, а не из памяти

**Шаг 2: Выставление данных**
- На **шину данных** процессор выставляет сигналы, соответствующие информации
- Эта информация должна быть передана в порт

**Шаг 3: Активация управляющих сигналов**
- На **шину управления** выставляются сигналы, соответствующие:
  - Операции **записи** (Write)
  - Работе с **устройствами ввода-вывода** (I/O Select) — **переключение адресных пространств!**
- Это приведёт к передаче необходимой информации в требуемый порт

**Команды процессора:**
```assembly
IN  Reg, Port   ; Чтение из порта в регистр
OUT Port, Reg   ; Запись из регистра в порт
```
---
### Варианты организации адресного пространства
Существует несколько подходов к организации адресных пространств памяти и ввода-вывода:
#### 1. Раздельные адресные пространства
- **Отдельное адресное пространство для памяти**
- **Отдельное адресное пространство для ввода-вывода**
- Используются специальные команды IN/OUT для работы с портами
- Требуется сигнал на шине управления для различения обращений

**Преимущества:**
- Чёткое разделение памяти и I/O
- Защита портов от случайного доступа

**Недостатки:**
- Требуются специальные команды процессора
- Усложнение архитектуры

#### 2. Отображение на адресное пространство памяти (Memory-Mapped I/O)
- Порты ввода-вывода отображены в адресное пространство памяти
- **Адресное пространство I/O выводится из пользовательского адресного пространства**
- Работа с портами через обычные команды работы с памятью

**Преимущества:**
- Не требуются специальные команды IN/OUT
- Можно использовать все команды работы с памятью
- Проще механизмы защиты

**Недостатки:**
- Уменьшается доступное адресное пространство для памяти
- Возможны конфликты адресов

#### 3. Гибридный подход
- Сочетание обоих методов
- Часть устройств — через отдельное адресное пространство
- Часть устройств — через отображение в память

**Применение:**
- В современных архитектурах часто используется гибридный подход
- Высокопроизводительные устройства (видеокарты) — через memory-mapped I/O
- Простые порты — через отдельное адресное пространство
---
## Архитектура контроллеров устройств
### Роль и назначение контроллера
#### Ключевое отличие памяти от устройств I/O
**Операции с памятью:**
- Занесение информации в память **является окончанием** операции записи
- Операция завершена, как только данные записаны

**Операции с устройствами I/O:**
- Занесение информации в порт **является инициализацией** реального совершения операции ввода-вывода
- Операция только начинается после записи в порт

**Роль контроллера:**
> Что именно должны совершать устройства, приняв информацию через свой порт, и каким именно образом они должны поставлять информацию для чтения из порта, определяется электронными схемами устройств, получившими названия **контроллеров**.

#### Область управления контроллера
**Контроллер может:**
1. **Непосредственно управлять отдельным устройством**
   - Например: контроллер конкретного диска

2. **Управлять несколькими устройствами**
   - Связывается с их контроллерами посредством **специальных шин ввода-вывода**
   - Примеры шин: шина IDE, шина SCSI, SATA, USB
---
### Разнообразие контроллеров
**Внутреннее строение:**
- Контроллеры устройств ввода-вывода **весьма различны** как по внутреннему строению, так и по исполнению
- Им приходится управлять совершенно разными приборами

**Диапазон сложности:**
- **От одной микросхемы** (простой контроллер последовательного порта)
- **До специализированной вычислительной системы** со своим процессором, памятью, прошивкой
- Современные контроллеры дисков и сетевых карт — фактически отдельные компьютеры

---
### Регистры контроллера
#### Стандартный набор регистров
Обычно каждый контроллер имеет, по крайней мере, **четыре внутренних регистра**:
1. **Регистр состояния** (Status Register)
2. **Регистр управления** (Control Register)
3. **Регистр входных данных** (Data In Register)
4. **Регистр выходных данных** (Data Out Register)

**Доступ к регистрам:**
- Для доступа к содержимому этих регистров вычислительная система может использовать **один или несколько портов**
- Для простоты изложения будем считать, что **каждому регистру соответствует свой собственный порт**

---
#### 1. Регистр состояния (Status Register)
**Назначение:**
- Содержит биты, значение которых **определяется состоянием устройства** ввода-вывода
- Доступны **только для чтения** вычислительной системой

**Типичные биты:**
- **Бит занятости (Busy bit)**
  - Индицирует, что устройство выполняет команду
  - 1 = устройство занято, 0 = устройство свободно

- **Бит готовности данных (Ready bit)**
  - Наличие очередного данного в регистре выходных данных
  - 1 = данные готовы для чтения, 0 = данных нет

- **Бит ошибки (Error bit)**
  - Возникновение ошибки при выполнении команды
  - 1 = произошла ошибка, 0 = ошибок нет

- **Дополнительные биты:**
  - Тип ошибки (код ошибки)
  - Состояние готовности устройства
  - Флаги специфичных для устройства состояний
---
#### 2. Регистр управления (Control Register)
**Назначение:**
- Получает данные, которые **записываются вычислительной системой**
- Служит для инициализации устройства или выполнения очередной команды
- Позволяет изменять режим работы устройства

**Типичное содержимое:**
- **Код выполняемой команды**
  - Часть битов отведена под команду (read, write, seek и т.д.)

- **Режим работы устройства**
  - Часть битов кодирует режим (синхронный/асинхронный, скорость и т.д.)

- **Бит готовности команды**
  - Свидетельствует о том, что можно приступить к выполнению команды
  - Устанавливается процессором после записи всех параметров

- **Параметры команды:**
  - Специфичные для устройства параметры операции
---
#### 3. Регистр выходных данных (Data Out Register)
**Назначение:**
- Служит для помещения в него данных **для чтения вычислительной системой**
- Данные помещаются контроллером после выполнения операции ввода

**Использование:**
- Устройство (контроллер) записывает данные в этот регистр
- Процессор читает данные из этого регистра
- Обычно используется при операциях **чтения с устройства**
---
#### 4. Регистр входных данных (Data In Register)
**Назначение:**
- Предназначен для помещения в него информации, которая должна быть **выведена на устройство**
- Данные записываются процессором для последующей передачи на устройство

**Использование:**
- Процессор записывает данные в этот регистр
- Контроллер читает данные из этого регистра
- Обычно используется при операциях **записи на устройство**

---
#### Ёмкость регистров данных
**Типичная ёмкость:**
- Обычно ёмкость регистров данных **не превышает ширину линии данных**
- Чаще всего **меньше** ширины шины данных
- Например: 8 или 16 бит при 64-битной шине данных

**Буферизация:**
- Некоторые контроллеры могут использовать вместо регистров **очередь FIFO**
- Очередь служит для **буферизации поступающей информации**
- Позволяет сгладить различия в скоростях процессора и устройства
---
## Взаимодействие процессора и контроллера
### Метод опроса устройств (Polling)
#### Операция записи на устройство
**Рассмотрим операцию записи на устройство без проверки успешности вывода:**
**Шаг 1: Ожидание готовности устройства**
- Процессор **в цикле читает** информацию из порта регистра состояний
- Проверяет значение **бита занятости**
- **Если бит занятости установлен:**
  - Устройство ещё не завершило предыдущую операцию
  - Процессор уходит на новую итерацию цикла (продолжает ждать)
- **Если бит занятости сброшен:**
  - Устройство готово к выполнению новой операции
  - Процессор переходит на следующий шаг

**Шаг 2: Запись команды**
- Процессор записывает **код команды вывода** в порт регистра управления

**Шаг 3: Запись данных**
- Процессор записывает **данные** в порт регистра входных данных

**Шаг 4: Активация выполнения**
- Процессор устанавливает **бит готовности команды**
- В следующих шагах **процессор не задействован**

**Шаг 5: Обнаружение команды контроллером**
- Контроллер замечает, что бит готовности команды установлен
- Контроллер устанавливает **бит занятости**

**Шаг 6: Анализ и выполнение**
- Контроллер анализирует код команды в регистре управления
- Обнаруживает, что это команда вывода
- Берёт данные из регистра входных данных
- **Инициирует выполнение команды** (начинает физическую операцию с устройством)

**Шаг 7: Завершение операции**
- После завершения операции контроллер **обнуляет бит готовности команды**

**Шаг 8: Индикация результата**
- **При успешном завершении:** контроллер обнуляет бит ошибки в регистре состояния
- **При неудачном завершении:** контроллер устанавливает бит ошибки

**Шаг 9: Освобождение устройства**
- Контроллер **сбрасывает бит занятости**
- Устройство снова готово к приёму команд
---
#### Проверка успешности выполнения
**Если процессор интересует корректность выполнения:**
- После шага 4 процессор должен **в цикле считывать** информацию из порта регистра состояний
- Ждёт, пока не будет **сброшен бит занятости** устройства
- После этого **анализирует состояние бита ошибки**
---
#### Анализ метода опроса
**Проблема:**
> Как видим, на первом шаге (и, возможно, после шага 4) процессор ожидает освобождения устройства, **непрерывно опрашивая значение бита занятости**.

**Название метода:**
- Такой способ взаимодействия процессора и контроллера получил название **polling** (опрос)
- В русском переводе — **способ опроса устройств**

**Эффективность метода:**

**Случай 1: Скорости примерно равны**
- Если скорости работы процессора и устройства ввода-вывода **примерно равны**
- Это не приводит к существенному уменьшению полезной работы процессора
- Метод приемлем

**Случай 2: Устройство значительно медленнее**
- Если скорость работы устройства **существенно меньше** скорости процессора
- Указанная техника **резко снижает производительность** системы
- Процессор тратит огромное количество времени в цикле ожидания
- Необходимо применять **другой архитектурный подход**

**Пример неэффективности:**
- Современный процессор: 3 ГГц (3 миллиарда операций в секунду)
- Жёсткий диск: время доступа ~10 мс (0.01 секунды)
- За время ожидания процессор мог бы выполнить 30 миллионов операций!
---
### Метод прерываний (Interrupts)
#### Необходимость прерываний
**Проблема метода опроса:**
- Процессор дожидается готовности устройства ввода-вывода **в цикле**
- Не может выполнять другую полезную работу

**Решение:**
> Для того чтобы процессор не дожидался состояния готовности устройства ввода-вывода в цикле, а мог **выполнять в это время другую работу**, необходимо, чтобы устройство само умело **сигнализировать процессору о своей готовности**.

**Механизм прерываний:**
- Технический механизм, который позволяет внешним устройствам **оповещать процессор**:
  - О завершении команды вывода
  - О завершении команды ввода
  - О возникновении исключительных ситуаций
---
#### Простейшая реализация прерываний
**Аппаратная поддержка:**
Для реализации механизма прерываний необходимо:
- К имеющимся шинам локальной магистрали добавить ещё одну линию
- **Линия прерываний** — соединяет процессор и устройства ввода-вывода

**Работа механизма:**
**1. Сигнал от устройства:**
- По завершении выполнения операции внешнее устройство **выставляет на линию прерываний специальный сигнал**

**2. Реакция процессора:**
- Процессор обнаруживает сигнал **после выполнения очередной команды**
- Или после завершения очередной итерации при выполнении цепочечных команд
- Процессор **изменяет своё поведение**

**3. Вместо выполнения очередной команды:**
- Процессор частично **сохраняет содержимое своих регистров**
- Переходит на выполнение **программы обработки прерывания** (ISR – Interrupt Service Routine)
- Программа расположена по **заранее оговорённому адресу**
---
#### Действия процессора при прерывании
**Последовательность действий при наличии только одной линии прерываний:**
**1. Опрос устройств (Polling прерываний!):**
- Процессор при выполнении программы обработки прерывания должен **опросить состояние всех устройств** ввода-вывода
- Цель: определить, от какого именно устройства пришло прерывание
- Проблема: при большом количестве устройств это занимает время

**2. Выполнение необходимых действий:**
- Вывести в это устройство очередную порцию информации
- Перевести соответствующий процесс из состояния "ожидание" в состояние "готовность"
- Обработать ошибку
- Выполнить другие специфичные для устройства действия

**3. Снятие прерывания:**
- Сообщить устройству, что прерывание обработано
- **Снять прерывание** (сбросить флаг прерывания в контроллере)

**4. Возврат из обработчика:**
- Восстановить сохранённые регистры
- Вернуться к выполнению прерванной программы
---
#### Шина и контроллер прерываний
**Проблема одной линии:**
- При наличии только одной линии прерываний требуется опрос всех устройств
- Неэффективно при большом количестве устройств

**Решение: контроллер прерываний**

**Архитектура:**
- Устройства сообщают о своей готовности процессору **не напрямую**
- А через **специальный контроллер прерываний** (Interrupt Controller)
- Для общения с процессором контроллер может использовать **целую шину прерываний**

**Идентификация источника прерывания:**
**1. Номер прерывания:**
- Каждому устройству присваивается **свой номер прерывания** (IRQ — Interrupt Request)

**2. Фиксация прерывания:**
- При возникновении прерывания контроллер прерываний заносит номер в **свой регистр состояния**

**3. Передача номера процессору:**
- После распознавания процессором сигнала прерывания
- После получения от процессора специального запроса
- Контроллер выставляет номер на **шину прерываний** или **шину данных** для чтения процессором

**Таблица прерываний:**
**1. Структура:**
- Номер прерывания обычно служит **индексом в специальной таблице прерываний**
- Таблица лежит по адресу, задаваемому при инициализации вычислительной системы

**2. Содержимое таблицы:**
- Содержит **адреса программ обработки прерываний**
- Эти адреса называются **вектора прерываний** (Interrupt Vectors)

**3. Работа механизма:**
- Процессор получает номер прерывания от контроллера
- Использует его как индекс в таблице прерываний
- Извлекает адрес обработчика
- Передаёт управление по этому адресу

**Преимущества:**
- Не требуется опрос всех устройств
- Быстрая идентификация источника прерывания
- Каждое устройство имеет свой обработчик

![[OS 88.png]]